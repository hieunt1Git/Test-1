# 6. Data GG sheet to CNVCDP (Code Appscrip l·ªçc tr√πng)

## **T·ªïng quan**

Data b√™n ƒë·ªëi t√°c Social heat -------> h·ªá th·ªëng CDP Hub (data hub) ------> g·ª≠i tin khi c√≥ d·ªØ li√™u th√™m moi trong data hub.

<figure><img src="../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

## T√†i nguy√™n

| <p>(1)<br></p> | <p><br></p>                                           | [2026 SocialHeat Automation - CNV - GGSheet](https://docs.google.com/spreadsheets/d/1QKnXp51omHkhdRN1Kk3SguzKTxDe7GqWwEFKK51KlS0/edit?gid=0#gid=0)      | GG sheet                  | <p><br></p> | C·ªßa ƒë·ªëi t√°c                               |
| -------------- | ----------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------- | ----------- | ----------------------------------------- |
| (2)            | <p><br></p>                                           | [Social heat \_CDP](https://docs.google.com/spreadsheets/d/1csYc31eHl3_YrYDOeHu-Y0SK7CGVmIp8gZ11YWfKQRU/edit?gid=0#gid=0)                               | GG sheet                  | <p><br></p> | Back up data                              |
| (3)            | [63883](https://hub.cnvcdp.com/update-campaign/63883) | <p><a href="https://hub.cnvcdp.com/update-campaign/63883">Socialheat 1. Get Data social heat</a><br></p>                                                | <p>Chi·∫øn D·ªãch hub<br></p> | **ON**      | Chi·∫øn d·ªãch nh·∫≠n data Social heat tr√™n CDP |
| (4)            | [64143](https://hub.cnvcdp.com/update-campaign/64143) | [SocialHeat 2. G·ª≠i tin x√°c nh·∫≠n - Social Heat](https://hub.cnvcdp.com/update-campaign/64143)                                                            | <p>Chi·∫øn D·ªãch hub<br></p> | **Pending** | G·ª≠i tin x√°c nh·∫≠n tham gia kh√≥a h·ªçc        |
| (5)            | 436100                                                | [X√°c nh·∫≠n ƒëƒÉng k√Ω tham gia s·ª± ki·ªán ‚Äì G·ª≠i kh√°ch t·ª´ Social Heat](https://app.cnvloyalty.com/social-loyalty/zalo/zns/08dd9bff-ec23-4286-8a65-bbc8b9eeb8eb) | Tin ZNS                   | **ON**      | Tin nh·∫Øn Social                           |
| (6)            | 436084                                                | [X√°c nh·∫≠n ƒëƒÉng k√Ω d·ªãch v·ª• ‚Äì G·ª≠i cho kh√°ch ƒëi·ªÅn leadform](https://app.cnvloyalty.com/social-loyalty/zalo/zns/08dd9bff-ec23-42b5-808f-e8cbb13f24fb)       | Tin ZNS                   | **ON**      | <p><br></p>                               |

## Set up

{% stepper %}
{% step %}
**T·∫°o App scrip tr√™n GG sheet c·ªßa ƒë·ªëi t√°c**

```javascript
//Code:  Tr√™n GG c·ªßa ƒë·ªëi t√°c
function onChange(e) {
  const sheetName = "socialheat_lead";
  const phoneCol = 5; // C·ªôt Phone (E)
  const emailCol = 6; // C·ªôt Email (F)
  const nameCol = 3;  // C·ªôt Name (C)

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  const lastRow = sheet.getLastRow();

  // L·∫•y d·ªØ li·ªáu d√≤ng cu·ªëi c√πng
  const rowData = sheet.getRange(lastRow, 1, 1, sheet.getLastColumn()).getValues()[0];

  const phone = rowData[phoneCol - 1];
  const email = rowData[emailCol - 1];
  const name = rowData[nameCol - 1];

  // Ki·ªÉm tra n·∫øu c√≥ s·ªë ƒëi·ªán tho·∫°i th√¨ m·ªõi g·ª≠i
  if (phone && phone.toString().trim() !== "") {
    const payload = {
      name: name,
      email: email,
      phone: phone
    };

    // Log th√¥ng tin g·ª≠i
    console.log("Sending data:", JSON.stringify(payload));

    // G·ª≠i t·ªõi API ho·∫∑c webhook
    const options = {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify(payload)
    };

    // V√≠ d·ª• URL webhook - thay b·∫±ng URL th·∫≠t c·ªßa b·∫°n
    const url = "https://script.google.com/macros/s/AKfycbzg3LTwGndvU8lMhwN1u8NlPxWKOWOcQN68TLHC1zJVmILYbi65NldsQwngMLBu2YFf/exec";
    const response = UrlFetchApp.fetch(url, options);

    console.log("Response code:", response.getResponseCode());
    console.log("Response body:", response.getContentText());
  } else {
    console.log("No phone number found in last row. Skipping send.");
  }
}
```
{% endstep %}

{% step %}
**T·∫°o GG sheet ƒë·ªÉ back up tr√°nh ·∫£nh h∆∞·ªüng ƒë·∫øn d·ªØ li·ªáu tr√™n file c·ªßa ƒë·ªëi t√°c v√† ƒë·ªÉ check d·ªØ li·ªáu g·ª≠i ƒëi**

```javascript
function doPost(e) {
  const sheetName = "Socialheat_CDP";
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);

  const logs = [];

  if (!sheet) {
    const msg = "‚ùå Kh√¥ng t√¨m th·∫•y sheet: " + sheetName;
    logs.push(msg);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: msg,
      logs
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const payloadRaw = e.postData.contents;
    logs.push("üì• Payload nh·∫≠n ƒë∆∞·ª£c: " + payloadRaw);

    const payload = JSON.parse(payloadRaw);
    const name = payload.name?.toString().trim() || "";
    const email = payload.email?.toString().trim() || "";
    const phoneRaw = payload.phone?.toString().trim() || "";
    const date = new Date();

    logs.push("üë§ T√™n: " + name);
    logs.push("üìß Email: " + email);
    logs.push("üìû SƒêT nh·∫≠n ƒë∆∞·ª£c (gi·ªØ nguy√™n): [" + phoneRaw + "]");

    // Ki·ªÉm tra tr√πng
    let isDuplicate = false;
    const numRows = sheet.getLastRow();

    if (numRows > 1) {
      const phoneCol = sheet.getRange(2, 4, numRows - 1).getValues(); // C·ªôt D t·ª´ d√≤ng 2
      const existingPhones = phoneCol
        .map(row => row[0]?.toString()?.trim() || "")
        .filter(p => p !== "");

      logs.push("üìã Danh s√°ch s·ªë ƒë√£ c√≥: " + JSON.stringify(existingPhones));
      isDuplicate = existingPhones.includes(phoneRaw);
    }

    if (isDuplicate) {
      const msg = "‚ö†Ô∏è S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i: " + phoneRaw;
      logs.push(msg);
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: msg,
        logs
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // Ghi v√†o Sheet
    sheet.appendRow([date, name, email, phoneRaw]);
    logs.push(‚úÖ Ghi th√†nh c√¥ng: [${date}, ${name}, ${email}, ${phoneRaw}]);

    // G·ª≠i webhook CNV CDP
    const sendPayload = { name, email, phone: phoneRaw };
    const url = "https://hub.cnvcdp.com/webhook/fd29a21b-8a41-40b9-a8a5-0f8b224c57c9-7834-068e0c87510b-a09a68c9f";
    const options = {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify(sendPayload),
      muteHttpExceptions: true
    };

    logs.push("üì¶ Payload g·ª≠i ƒëi: " + JSON.stringify(sendPayload));

    const response = UrlFetchApp.fetch(url, options);
    const status = response.getResponseCode();
    const body = response.getContentText();

    logs.push("üöÄ Webhook status: " + status);
    logs.push("üìù Webhook ph·∫£n h·ªìi: " + body);

    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: "Ghi v√† g·ª≠i th√†nh c√¥ng.",
        logs
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    logs.push("‚ùå L·ªói: " + error.toString());
    logs.push("‚ùå Stacktrace: " + (error.stack || "Kh√¥ng c√≥ stack"));

    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: "L·ªói x·ª≠ l√Ω d·ªØ li·ªáu.",
        error: error.message || error.toString(),
        stack: error.stack || "",
        logs
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
```

{% hint style="info" %}
L∆∞u √Ω khi t·∫°o b·∫£ng: [Social heat \_CDP](https://docs.google.com/spreadsheets/d/1csYc31eHl3_YrYDOeHu-Y0SK7CGVmIp8gZ11YWfKQRU/edit?gid=0#gid=0)**\*\* Ki·ªÉu d·ªØ li·ªáu c·ªßa c·ªôt phone ph·∫£i ƒë·ªÉ ·ªü d·∫°ng Text**
{% endhint %}
{% endstep %}

{% step %}
**T·∫°o chi·∫øn d·ªãch Nh·∫≠n v√† g·ª≠i tin ZNS**

<figure><img src="https://cnvloyalty.sg.larksuite.com/space/api/box/stream/download/asynccode/?code=OGI3M2IwNjZhNDEzZjI1ZjZlYTNmZjI2YzE3NmY2ZjJfU3Nxd2l1QTlVdm9Yc1NsTjlJOWtWMnNjVEtvOG1xZ0dfVG9rZW46WU1PZGJJWDZSb1VXTnB4b2xlNWxIOWlJZ1NmXzE3NTQzNzYwNzc6MTc1NDM3OTY3N19WNA" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>
{% endstep %}

{% step %}
**B4: ƒêƒÉng K√≠ tin ZNS**


{% endstep %}
{% endstepper %}
